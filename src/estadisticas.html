<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Estadísticas de tu cuestionario - Aprende y Aplica IA">
    <title>Mis Estadísticas - Aprende y Aplica IA</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/images/icono.png" />
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/animations.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/estadisticas.css">
    <link rel="stylesheet" href="styles/responsive.css">
    <!-- Navbar reutilizado -->
    <link rel="stylesheet" href="styles/courses.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Boxicons para iconos -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    
    <!-- Global theme setup - Configuración global del tema -->
    <script src="scripts/global-theme-setup.js"></script>
</head>
<body class="bg-glow-global">
    <!-- Botón de cambio de tema -->
    <button class="theme-toggle-btn" title="Cambiar tema">
        <svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>

    <!-- Fondo avanzado como en new-auth -->
    <div class="auth-bg">
        <div class="bg-glow"></div>
        <canvas id="bgParticles"></canvas>
    </div>
    
    <!-- Partículas flotantes mejoradas -->
    <div class="particles-container">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- Header simple con navbar por defecto (sin perfil) -->
    <header class="catalog-header">
        <div class="container">
            <div class="course-tabs">
                <button class="tab-button" onclick="location.href='cursos.html'">
                    <i class='bx bx-collection'></i>
                    Talleres
                </button>
                <button class="tab-button" onclick="location.href='coming-soon.html'">
                    <i class='bx bx-group'></i>
                    Comunidad
                </button>
                <button class="tab-button" onclick="location.href='coming-soon.html'">
                    <i class='bx bx-news'></i>
                    Noticias
                </button>
            </div>
        </div>
    </header>

    <!-- Contenido Principal -->
    <main class="stats-main" style="padding-top: 90px;">
        <div class="container">
            <!-- Header de la página -->
            <section class="stats-header-section animate-on-scroll">
                <div class="stats-header-content">
                    <div class="stats-header-text">
                        <h1>Mis Estadísticas</h1>
                        <p>Mis resultados</p>
                    </div>
                </div>
            </section>

            <!-- Contenedores para Grafana - Diseño Piramidal -->
            <section class="grafana-section animate-on-scroll">
                <div class="grafana-pyramid">
                    <!-- Panel superior (más ancho) -->
                    <div class="grafana-container glass-card top">
                        <div class="grafana-header">
                            <h3><i class='bx bx-line-chart'></i> Índice de Competencias</h3>
                            <p>Resumen general de tus competencias en IA y tecnologías emergentes</p>
                        </div>
                        <div class="grafana-frame-container">
                            <img src="/grafana/panel/1.png" 
                                 style="width:100%;min-height:420px;border-radius:16px" 
                                 alt="Índice de Competencias"
                                 class="grafana-image"
                                 loading="lazy" />
                        </div>
                    </div>

                    <!-- Fila inferior con dos paneles -->
                    <div class="grafana-bottom-row">
                        <!-- Panel inferior izquierdo -->
                        <div class="grafana-container glass-card bottom">
                            <div class="grafana-header">
                                <h3><i class='bx bx-bullseye'></i> Radar de Habilidades</h3>
                                <p>Visualización de tus fortalezas por área funcional y nivel de experiencia</p>
                            </div>
                            <div class="grafana-frame-container">
                                <img src="/grafana/panel/2.png" 
                                     style="width:100%;min-height:420px;border-radius:16px" 
                                     alt="Radar de Habilidades"
                                     class="grafana-image"
                                     loading="lazy" />
                            </div>
                        </div>

                        <!-- Panel inferior derecho -->
                        <div class="grafana-container glass-card bottom">
                            <div class="grafana-header">
                                <h3><i class='bx bx-category-alt'></i> Análisis por Subdominios</h3>
                                <p>Desglose detallado por categorías específicas y oportunidades de mejora</p>
                            </div>
                            <div class="grafana-frame-container">
                                <img src="/grafana/panel/3.png" 
                                     style="width:100%;min-height:420px;border-radius:16px" 
                                     alt="Análisis por Subdominios"
                                     class="grafana-image"
                                     loading="lazy" />
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Scripts -->
    <script src="scripts/particles.js"></script>
    <script src="scripts/estadisticas.js"></script>
    
    <!-- Script de partículas de fondo (como new-auth) -->
    <script>
        // Sistema de partículas del canvas (como new-auth)
        const canvas = document.getElementById('bgParticles');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            let particles = [];
            
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            function createParticle() {
                return {
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 3 + 1,
                    speedX: (Math.random() - 0.5) * 0.5,
                    speedY: (Math.random() - 0.5) * 0.5,
                    opacity: Math.random() * 0.5 + 0.2,
                    color: Math.random() > 0.5 ? '#44E5FF' : '#0077A6'
                };
            }
            
            function initParticles() {
                particles = [];
                for (let i = 0; i < 50; i++) {
                    particles.push(createParticle());
                }
            }
            
            function updateParticles() {
                particles.forEach(particle => {
                    particle.x += particle.speedX;
                    particle.y += particle.speedY;
                    
                    if (particle.x < 0 || particle.x > canvas.width) particle.speedX *= -1;
                    if (particle.y < 0 || particle.y > canvas.height) particle.speedY *= -1;
                    
                    particle.opacity += (Math.random() - 0.5) * 0.01;
                    particle.opacity = Math.max(0.1, Math.min(0.7, particle.opacity));
                });
            }
            
            function drawParticles() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                particles.forEach(particle => {
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fillStyle = particle.color;
                    ctx.globalAlpha = particle.opacity;
                    ctx.fill();
                    
                    // Agregar glow
                    ctx.shadowColor = particle.color;
                    ctx.shadowBlur = 10;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });
            }
            
            function connectParticles() {
                for (let i = 0; i < particles.length; i++) {
                    for (let j = i + 1; j < particles.length; j++) {
                        const dx = particles[i].x - particles[j].x;
                        const dy = particles[i].y - particles[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 120) {
                            ctx.beginPath();
                            ctx.moveTo(particles[i].x, particles[i].y);
                            ctx.lineTo(particles[j].x, particles[j].y);
                            ctx.strokeStyle = '#44E5FF';
                            ctx.globalAlpha = (120 - distance) / 120 * 0.2;
                            ctx.lineWidth = 1;
                            ctx.stroke();
                        }
                    }
                }
            }
            
            function animate() {
                updateParticles();
                drawParticles();
                connectParticles();
                requestAnimationFrame(animate);
            }
            
            window.addEventListener('resize', () => {
                resizeCanvas();
                initParticles();
            });
            
            resizeCanvas();
            initParticles();
            animate();
        }
    </script>
    
    <script>
        // Cargar session_id y actualizar URLs de Grafana
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Inicializando estadísticas con session_id dinámico...');
            
            // Obtener token del localStorage
            const token = localStorage.getItem('userToken') || localStorage.getItem('authToken');
            
            if (!token) {
                console.warn('No hay token de autenticación - usando imágenes por defecto');
                // Agregar manejo de errores para todas las imágenes
                const grafanaImages = document.querySelectorAll('img[src*="/grafana/panel/"]');
                grafanaImages.forEach(img => {
                    img.onerror = function() {
                        console.warn(`Error cargando imagen sin token: ${this.alt}`);
                        showGrafanaPlaceholder(this);
                    };
                });
                return;
            }
            
            try {
                // Temporalmente skip session_id para testing
                console.log('⚠️ Modo testing: sin session_id dinámico');
                
                // Solo agregar manejo de errores sin modificar URLs
                const grafanaImages = document.querySelectorAll('img[src*="/grafana/panel/"]');
                grafanaImages.forEach(img => {
                    img.onerror = function() {
                        console.warn(`Error cargando imagen: ${this.alt}`);
                        showGrafanaPlaceholder(this);
                    };
                    
                    img.onload = function() {
                        console.log(`✅ Imagen cargada correctamente: ${this.alt}`);
                    };
                });
                
                console.log(`🖼️ ${grafanaImages.length} imágenes configuradas para testing`);
                
                // Comentado temporalmente:
                // const response = await fetch('/api/session-info', {
                //     headers: {
                //         'Authorization': `Bearer ${token}`
                //     }
                // });
                // 
                // if (!response.ok) {
                //     console.warn('Error obteniendo session info:', response.status);
                //     return;
                // }
                // 
                // const sessionInfo = await response.json();
                // console.log('Session info obtenida:', sessionInfo);
                // 
                // // Actualizar URLs de las imágenes con session_id
                // updateGrafanaImages(sessionInfo.session_id);
                
            } catch (error) {
                console.error('Error en modo testing:', error);
            }
        });
        
        function updateGrafanaImages(sessionId) {
            // Encontrar todas las imágenes de Grafana
            const grafanaImages = document.querySelectorAll('img[src*="/grafana/panel/"]');
            
            grafanaImages.forEach(img => {
                const currentSrc = img.src;
                const url = new URL(currentSrc);
                
                // Añadir session_id como parámetro
                url.searchParams.set('session_id', sessionId);
                
                // Agregar manejo de errores para la imagen
                img.onerror = function() {
                    console.warn(`Error cargando imagen: ${this.alt}`);
                    showGrafanaPlaceholder(this);
                };
                
                img.onload = function() {
                    console.log(`✅ Imagen cargada correctamente: ${this.alt}`);
                };
                
                // Actualizar la imagen
                img.src = url.toString();
                console.log(`Imagen actualizada: ${img.alt} -> ${url.toString()}`);
            });
            
            console.log(`✅ ${grafanaImages.length} imágenes actualizadas con session_id: ${sessionId}`);
        }
        
        function showGrafanaPlaceholder(imgElement) {
            // Ocultar imagen rota
            imgElement.style.display = 'none';
            
            // Crear placeholder personalizado
            const errorDiv = document.createElement('div');
            errorDiv.className = 'grafana-placeholder';
            errorDiv.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 420px; background: rgba(68, 229, 255, 0.1); border-radius: 16px; border: 2px dashed #44e5ff;">
                    <i class='bx bx-bar-chart-alt-2' style="font-size: 48px; color: #44e5ff; margin-bottom: 16px;"></i>
                    <h4 style="color: #44e5ff; margin: 0 0 8px 0;">Dashboard de ${imgElement.alt}</h4>
                    <p style="color: #888; margin: 0 0 8px 0; text-align: center;">Panel en construcción</p>
                    <p style="color: #666; margin: 0; font-size: 12px; text-align: center;">Configura GRAFANA_SA_TOKEN para ver datos reales</p>
                </div>
            `;
            imgElement.parentNode.appendChild(errorDiv);
        }
    </script>
    <script src="scripts/theme-toggle.js"></script>
    
    <!-- Script de prueba para el botón de tema -->
    <script>
        // Función simple para cambiar tema
        function toggleTheme() {
            console.log('🔄 Cambiando tema...');
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            // Aplicar el nuevo tema
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            console.log('✅ Tema cambiado a:', newTheme);
        }
        
        // Hacer la función disponible globalmente
        window.toggleTheme = toggleTheme;
        
        // Inicializar tema al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Aplicar tema guardado o usar dark por defecto
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            console.log('🎨 Tema inicial aplicado:', savedTheme);
            
            // Agregar evento de click al botón
            const themeBtn = document.querySelector('.theme-toggle-btn');
            if (themeBtn) {
                // Remover onclick del HTML y usar addEventListener
                themeBtn.removeAttribute('onclick');
                themeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🖱️ Botón de tema clickeado');
                    toggleTheme();
                });
                console.log('✅ Evento de click agregado al botón de tema');
            } else {
                console.error('❌ No se encontró el botón de tema');
            }
        });
        
        // Script adicional de prueba
        console.log('🔧 Script de tema cargado');
        
        // Verificar que el botón existe
        setTimeout(() => {
            const btn = document.querySelector('.theme-toggle-btn');
            if (btn) {
                console.log('✅ Botón encontrado:', btn);
                console.log('✅ Función toggleTheme disponible:', typeof toggleTheme);
            } else {
                console.error('❌ Botón no encontrado');
            }
        }, 1000);
    </script>
</body>
</html>