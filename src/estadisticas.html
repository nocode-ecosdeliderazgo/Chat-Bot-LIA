<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Estadísticas de tu cuestionario - Aprende y Aplica IA">
    <title>Mis Estadísticas - Aprende y Aplica IA</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/images/icono.png" />
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/animations.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/estadisticas.css">
    <link rel="stylesheet" href="styles/responsive.css">
    <!-- Navbar reutilizado -->
    <link rel="stylesheet" href="styles/courses.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Boxicons para iconos -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body class="bg-glow-global">
    <!-- Fondo con partículas -->
    <div class="particles-container"></div>

    <!-- Header simple con navbar por defecto (sin perfil) -->
    <header class="catalog-header">
        <div class="container">
            <div class="course-tabs">
                <button class="tab-button" onclick="location.href='cursos.html'">
                    <i class='bx bx-collection'></i>
                    Cursos
                </button>
                <button class="tab-button" onclick="location.href='Community/community.html'">
                    <i class='bx bx-group'></i>
                    Comunidad
                </button>
                <button class="tab-button" onclick="location.href='Notices/notices.html'">
                    <i class='bx bx-news'></i>
                    Noticias
                </button>
            </div>
        </div>
    </header>

    <!-- Contenido Principal -->
    <main class="stats-main" style="padding-top: 90px;">
        <div class="container">
            <!-- Header de la página -->
            <section class="stats-header-section animate-on-scroll">
                <div class="stats-header-content">
                    <div class="stats-header-text">
                        <h1>Mis Estadísticas</h1>
                        <p>Analiza tu progreso y resultados del cuestionario de perfil profesional con dashboards interactivos de Grafana</p>
                    </div>
                </div>
            </section>

            <!-- Contenedores para Grafana - Diseño Piramidal -->
            <section class="grafana-section animate-on-scroll">
                <div class="grafana-pyramid">
                    <!-- Panel superior (más ancho) -->
                    <div class="grafana-container glass-card top">
                        <div class="grafana-header">
                            <h3><i class='bx bx-line-chart'></i> Índice de Competencias</h3>
                            <p>Resumen general de tus competencias en IA y tecnologías emergentes</p>
                        </div>
                        <div class="grafana-frame-container">
                            <img src="/grafana/panel/1.png" 
                                 style="width:100%;min-height:420px;border-radius:16px" 
                                 alt="Índice de Competencias"
                                 class="grafana-image"
                                 loading="lazy" />
                        </div>
                    </div>

                    <!-- Fila inferior con dos paneles -->
                    <div class="grafana-bottom-row">
                        <!-- Panel inferior izquierdo -->
                        <div class="grafana-container glass-card bottom">
                            <div class="grafana-header">
                                <h3><i class='bx bx-bullseye'></i> Radar de Habilidades</h3>
                                <p>Visualización de tus fortalezas por área funcional y nivel de experiencia</p>
                            </div>
                            <div class="grafana-frame-container">
                                <img src="/grafana/panel/6.png" 
                                     style="width:100%;min-height:420px;border-radius:16px" 
                                     alt="Radar de Habilidades"
                                     class="grafana-image"
                                     loading="lazy" />
                            </div>
                        </div>

                        <!-- Panel inferior derecho -->
                        <div class="grafana-container glass-card bottom">
                            <div class="grafana-header">
                                <h3><i class='bx bx-category-alt'></i> Análisis por Subdominios</h3>
                                <p>Desglose detallado por categorías específicas y oportunidades de mejora</p>
                            </div>
                            <div class="grafana-frame-container">
                                <img src="/grafana/panel/8.png" 
                                     style="width:100%;min-height:420px;border-radius:16px" 
                                     alt="Análisis por Subdominios"
                                     class="grafana-image"
                                     loading="lazy" />
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Scripts -->
    <script src="scripts/particles.js"></script>
    <script src="scripts/estadisticas.js"></script>
    
    <script>
        // Cargar session_id y actualizar URLs de Grafana
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Inicializando estadísticas con session_id dinámico...');
            
            // Obtener token del localStorage
            const token = localStorage.getItem('userToken') || localStorage.getItem('authToken');
            
            if (!token) {
                console.warn('No hay token de autenticación - usando imágenes por defecto');
                // Agregar manejo de errores para todas las imágenes
                const grafanaImages = document.querySelectorAll('img[src*="/grafana/panel/"]');
                grafanaImages.forEach(img => {
                    img.onerror = function() {
                        console.warn(`Error cargando imagen sin token: ${this.alt}`);
                        showGrafanaPlaceholder(this);
                    };
                });
                return;
            }
            
            try {
                // Obtener información de la sesión
                const response = await fetch('/api/session-info', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    console.warn('Error obteniendo session info:', response.status);
                    return;
                }
                
                const sessionInfo = await response.json();
                console.log('Session info obtenida:', sessionInfo);
                
                // Actualizar URLs de las imágenes con session_id
                updateGrafanaImages(sessionInfo.session_id);
                
            } catch (error) {
                console.error('Error cargando session info:', error);
            }
        });
        
        function updateGrafanaImages(sessionId) {
            // Encontrar todas las imágenes de Grafana
            const grafanaImages = document.querySelectorAll('img[src*="/grafana/panel/"]');
            
            grafanaImages.forEach(img => {
                const currentSrc = img.src;
                const url = new URL(currentSrc);
                
                // Añadir session_id como parámetro
                url.searchParams.set('session_id', sessionId);
                
                // Agregar manejo de errores para la imagen
                img.onerror = function() {
                    console.warn(`Error cargando imagen: ${this.alt}`);
                    showGrafanaPlaceholder(this);
                };
                
                img.onload = function() {
                    console.log(`✅ Imagen cargada correctamente: ${this.alt}`);
                };
                
                // Actualizar la imagen
                img.src = url.toString();
                console.log(`Imagen actualizada: ${img.alt} -> ${url.toString()}`);
            });
            
            console.log(`✅ ${grafanaImages.length} imágenes actualizadas con session_id: ${sessionId}`);
        }
        
        function showGrafanaPlaceholder(imgElement) {
            // Ocultar imagen rota
            imgElement.style.display = 'none';
            
            // Crear placeholder personalizado
            const errorDiv = document.createElement('div');
            errorDiv.className = 'grafana-placeholder';
            errorDiv.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 420px; background: rgba(68, 229, 255, 0.1); border-radius: 16px; border: 2px dashed #44e5ff;">
                    <i class='bx bx-bar-chart-alt-2' style="font-size: 48px; color: #44e5ff; margin-bottom: 16px;"></i>
                    <h4 style="color: #44e5ff; margin: 0 0 8px 0;">Dashboard de ${imgElement.alt}</h4>
                    <p style="color: #888; margin: 0 0 8px 0; text-align: center;">Panel en construcción</p>
                    <p style="color: #666; margin: 0; font-size: 12px; text-align: center;">Configura GRAFANA_SA_TOKEN para ver datos reales</p>
                </div>
            `;
            imgElement.parentNode.appendChild(errorDiv);
        }
    </script>
</body>
</html>