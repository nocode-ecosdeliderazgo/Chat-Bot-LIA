<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comunidad - Detalle</title>
    <link rel="stylesheet" href="community.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Global theme setup - Configuración global del tema -->
    <script src="../scripts/global-theme-setup.js"></script>
    

</head>
<body class="bg-glow-global">
    <div class="particles-container"></div>

    <!-- Botón de regreso -->
    <button class="back-btn" onclick="window.location.href='community.html'" title="Volver a Comunidad">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        <span>Volver</span>
    </button>

    <!-- Botón de cambio de tema -->
    <button class="theme-toggle-btn" onclick="toggleTheme()" title="Cambiar tema">
        <svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>

    <nav class="community-subnav">
        <div class="subnav-inner">
            <div class="subnav-tabs">
                <button class="subnav-link active" data-tab="community">Comunidad</button>
                <button class="subnav-link" data-tab="members">Miembros</button>
                <button class="subnav-link" data-tab="about">Acerca de</button>
            </div>
            <div class="subnav-search">
                <i class="fas fa-search"></i>
                <input class="subnav-input" id="viewSearch" type="text" placeholder="Buscar en esta comunidad...">
            </div>
        </div>
    </nav>

    <main class="main-content" style="padding-top:10px">
        <section id="tab-community" class="feed-section">
            <div class="container">
                <div class="feed-main">
                    <div class="composer-card">
                        <div class="composer-avatar" id="composerAvatar">
                            <img id="composerAvatarImg" src="" alt="Tu foto de perfil" style="display: none;">
                            <i class="fas fa-user" id="composerAvatarIcon"></i>
                        </div>
                        <div class="composer-content">
                        <input id="composerInput" class="composer-input" type="text" placeholder="Escribe algo para la comunidad...">
                            <div class="composer-actions">
                                <button class="attach-menu-btn" id="attachMenuBtn" title="Agregar adjunto">
                                    <i class="fas fa-plus"></i>
                                    <span>Adjuntar</span>
                                </button>
                        <button id="publishPostBtn" class="composer-btn" disabled>Publicar</button>
                            </div>
                        </div>
                    </div>
                    <div class="attachments-preview" id="attachmentsPreview"></div>
                    <div class="feed-filters" id="feedFilters">
                        <button class="feed-chip active" data-category="all">Todos</button>
                        <button class="feed-chip" data-category="ia">IA</button>
                        <button class="feed-chip" data-category="datos">Datos</button>
                        <button class="feed-chip" data-category="desarrollo">Desarrollo</button>
                        <button class="feed-chip" data-category="diseno">Diseño</button>
                        <button class="feed-chip" data-category="it">IT & Software</button>
                        <button class="feed-chip" data-category="marketing">Marketing</button>
                        <button class="feed-chip" data-category="negocios">Negocios</button>
                    </div>
                    <div id="postsList" class="posts-list"></div>
                </div>
            </div>
        </section>

        <section id="tab-members" class="members-section" style="display:none">
            <div class="container">
                <div class="members-filters">
                    <button class="members-chip active" data-filter="all">Todos</button>
                    <button class="members-chip" data-filter="online">En línea</button>
                    <button class="members-chip" data-filter="admins">Admins</button>
                </div>
                <div id="membersList"></div>
            </div>
        </section>

        <section id="tab-about" class="guidelines-section" style="display:none">
            <div class="container">
                <div class="section-header">
                    <h2 class="section-title" id="aboutTitle">Acerca de esta comunidad</h2>
                    <p class="section-subtitle">Descripción general y recursos.</p>
                </div>
                <div class="guidelines-grid">
                    <div class="guideline-card">
                        <div class="guideline-icon"><i class="fas fa-play"></i></div>
                        <h3 class="guideline-title">Comienza aquí</h3>
                        <p class="guideline-description">Mira el video de introducción y conoce las reglas básicas.</p>
                    </div>
                    <div class="guideline-card">
                        <div class="guideline-icon"><i class="fas fa-bolt"></i></div>
                        <h3 class="guideline-title">Recursos</h3>
                        <p class="guideline-description">Plantillas, guías y descuentos para acelerar tu aprendizaje.</p>
                    </div>
                    <div class="guideline-card">
                        <div class="guideline-icon"><i class="fas fa-arrow-trend-up"></i></div>
                        <h3 class="guideline-title">Mejora</h3>
                        <p class="guideline-description">Sube de nivel participando y compartiendo aportes de calidad.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <button class="chat-fab" id="openChat">Chat</button>
    <div class="chat-panel" id="chatPanel">
        <div class="chat-head">
            <strong>Chat en vivo</strong>
            <button class="chat-send" id="closeChat">Cerrar</button>
        </div>
        <div class="chat-body" id="chatBody"></div>
        <div class="chat-input-row">
            <input id="chatInput" class="chat-input" type="text" placeholder="Escribe un mensaje...">
            <button id="chatSend" class="chat-send">Enviar</button>
        </div>
    </div>

    <!-- Modal de publicación -->
    <div class="post-modal" id="postModal">
        <div class="post-modal-card">
            <div class="post-modal-head">
                <strong id="modalPostUser">Publicación</strong>
                <button class="chat-send" id="closePostModal">Cerrar</button>
            </div>
            <div class="post-modal-body" id="modalPostBody"></div>
            <div class="post-modal-foot">
                <input id="modalCommentInput" class="comment-input" type="text" placeholder="Escribe un comentario...">
                <button id="modalSendComment" class="chat-send">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Modal de adjuntos -->
    <div class="attach-modal" id="attachModal">
        <div class="attach-modal-card">
            <div class="attach-modal-head">
                <strong>Agregar adjunto</strong>
                <button class="attach-modal-close" id="closeAttachModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="attach-modal-body">
                <div class="attach-options-grid">
                    <div class="attach-option" data-type="image">
                        <div class="attach-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21,15 16,10 5,21"></polyline>
                            </svg>
                        </div>
                        <div class="attach-option-content">
                            <h3>Foto/Video</h3>
                            <p>Sube una imagen o video</p>
                        </div>
                        <input type="file" id="attachImage" accept="image/*,video/*" hidden>
                    </div>
                    <div class="attach-option" data-type="document">
                        <div class="attach-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14,2 14,8 20,8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10,9 9,9 8,9"></polyline>
                            </svg>
                        </div>
                        <div class="attach-option-content">
                            <h3>Documento</h3>
                            <p>PDF, Word, PowerPoint, etc.</p>
                        </div>
                        <input type="file" id="attachDocument" accept=".pdf,.doc,.docx,.txt,.ppt,.pptx" hidden>
                    </div>
                    <div class="attach-option" data-type="link">
                        <div class="attach-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                            </svg>
                        </div>
                        <div class="attach-option-content">
                            <h3>Enlace</h3>
                            <p>Comparte un enlace web</p>
                        </div>
                    </div>
                    <div class="attach-option" data-type="youtube">
                        <div class="attach-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                                <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                                <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                            </svg>
                        </div>
                        <div class="attach-option-content">
                            <h3>YouTube</h3>
                            <p>Vincular video de YouTube</p>
                        </div>
                    </div>
                    <div class="attach-option" data-type="location">
                        <div class="attach-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                        </div>
                        <div class="attach-option-content">
                            <h3>Ubicación</h3>
                            <p>Compartir ubicación</p>
                        </div>
                    </div>
                    <div class="attach-option" data-type="poll">
                        <div class="attach-option-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                            </svg>
                        </div>
                        <div class="attach-option-content">
                            <h3>Encuesta</h3>
                            <p>Crear una encuesta</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para enlace -->
    <div class="input-modal" id="linkModal">
        <div class="input-modal-card">
            <div class="input-modal-head">
                <strong>Agregar enlace</strong>
                <button class="input-modal-close" id="closeLinkModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="input-modal-body">
                <div class="input-group">
                    <label for="linkInput">URL del enlace:</label>
                    <input type="url" id="linkInput" placeholder="https://ejemplo.com" class="input-field">
                </div>
                <div class="input-modal-actions">
                    <button class="input-modal-btn cancel" id="cancelLink">Cancelar</button>
                    <button class="input-modal-btn confirm" id="confirmLink">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para YouTube -->
    <div class="input-modal" id="youtubeModal">
        <div class="input-modal-card">
            <div class="input-modal-head">
                <strong>Agregar video de YouTube</strong>
                <button class="input-modal-close" id="closeYoutubeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="input-modal-body">
                <div class="input-group">
                    <label for="youtubeInput">URL de YouTube:</label>
                    <input type="url" id="youtubeInput" placeholder="https://youtube.com/watch?v=..." class="input-field">
                </div>
                <div class="input-modal-actions">
                    <button class="input-modal-btn cancel" id="cancelYoutube">Cancelar</button>
                    <button class="input-modal-btn confirm" id="confirmYoutube">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para ubicación -->
    <div class="input-modal" id="locationModal">
        <div class="input-modal-card">
            <div class="input-modal-head">
                <strong>Agregar ubicación</strong>
                <button class="input-modal-close" id="closeLocationModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="input-modal-body">
                <div class="input-group">
                    <label for="locationInput">¿Dónde estás?</label>
                    <input type="text" id="locationInput" placeholder="Madrid, España" class="input-field">
                </div>
                <div class="input-modal-actions">
                    <button class="input-modal-btn cancel" id="cancelLocation">Cancelar</button>
                    <button class="input-modal-btn confirm" id="confirmLocation">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para encuesta -->
    <div class="input-modal" id="pollModal">
        <div class="input-modal-card">
            <div class="input-modal-head">
                <strong>Crear encuesta</strong>
                <button class="input-modal-close" id="closePollModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="input-modal-body">
                <div class="input-group">
                    <label for="pollQuestion">Pregunta:</label>
                    <input type="text" id="pollQuestion" placeholder="¿Cuál es tu opinión?" class="input-field">
                </div>
                <div class="input-group">
                    <label for="pollOptions">Opciones (separadas por comas):</label>
                    <input type="text" id="pollOptions" placeholder="Opción 1, Opción 2, Opción 3" class="input-field">
                </div>
                <div class="input-modal-actions">
                    <button class="input-modal-btn cancel" id="cancelPoll">Cancelar</button>
                    <button class="input-modal-btn confirm" id="confirmPoll">Crear</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function(){
            try{
                // Cargar foto de perfil del usuario
                function loadUserProfilePicture() {
                    const composerAvatarImg = document.getElementById('composerAvatarImg');
                    const composerAvatarIcon = document.getElementById('composerAvatarIcon');
                    
                    // Intentar obtener la foto de perfil del localStorage
                    const userProfile = localStorage.getItem('userProfile');
                    const avatarData = localStorage.getItem('avatarData');
                    
                    if (avatarData) {
                        try {
                            const avatar = JSON.parse(avatarData);
                            if (avatar && avatar.dataUrl) {
                                composerAvatarImg.src = avatar.dataUrl;
                                composerAvatarImg.style.display = 'block';
                                composerAvatarIcon.style.display = 'none';
                                return;
                            }
                        } catch (e) {
                            console.log('Error parsing avatar data:', e);
                        }
                    }
                    
                    // Si no hay foto, mostrar el icono por defecto
                    composerAvatarImg.style.display = 'none';
                    composerAvatarIcon.style.display = 'block';
                }
                
                // Cargar la foto de perfil al iniciar
                loadUserProfilePicture();
                
                const rawCommunity = localStorage.getItem('community.view.item');
                const rawPost = localStorage.getItem('community.view.post');
                const detail = rawCommunity ? JSON.parse(rawCommunity) : (rawPost ? JSON.parse(rawPost) : null);
                if(detail){
                    document.getElementById('detailTitle').textContent = detail.title || detail.user || 'Detalle';
                    document.getElementById('detailDesc').textContent = detail.desc || detail.content || '';
                    const metaParts = [];
                    if(detail.members) metaParts.push(`${detail.members} Members`);
                    if(detail.price) metaParts.push(detail.price);
                    if(detail.category) metaParts.push(detail.category);
                    document.getElementById('detailMeta').textContent = metaParts.join(' • ');
                    if(detail.icon){ document.getElementById('detailIcon').className = detail.icon; }
                    document.getElementById('aboutTitle').textContent = detail.title || 'Acerca de';
                }
            }catch(e){ console.error(e); }
            // Tabs
            document.querySelectorAll('.subnav-link').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    document.querySelectorAll('.subnav-link').forEach(b=>b.classList.remove('active'));
                    btn.classList.add('active');
                    const tab = btn.getAttribute('data-tab');
                    document.querySelectorAll('main > section').forEach(s=>s.style.display='none');
                    document.getElementById('tab-'+tab).style.display='block';
                });
            });
            // Feed mock
            const posts = [
                { id:1, user:'Nate Herk', avatar:'fas fa-user', category:'ia', minutesAgo:60, content:'Nuevo video: cómo construir un agente IA con n8n.', comments:[], reactions:{like:12, heart:3}, attachments:[], reacted: null },
                { id:2, user:'Ana Martínez', avatar:'fas fa-user', category:'datos', minutesAgo:5, content:'¿Qué herramienta recomiendan para orquestar pipelines?', comments:[], reactions:{like:2, heart:1}, attachments:[], reacted: null },
                { id:3, user:'Carlos López', avatar:'fas fa-user', category:'desarrollo', minutesAgo:15, content:'Comparto un boilerplate para APIs serverless.', comments:[], reactions:{like:1, heart:0}, attachments:[], reacted: null }
            ];
            let pendingAttachments = [];
            const composerInput = document.getElementById('composerInput');
            const publishPostBtn = document.getElementById('publishPostBtn');
            function renderPosts(category='all'){
                const list = document.getElementById('postsList');
                const filtered = category==='all' ? posts : posts.filter(p=>p.category===category);
                list.innerHTML = filtered.map(p=>`
                    <div class="post-card" data-open-post="${p.id}">
                        <div class="post-avatar"><i class="${p.avatar}"></i></div>
                        <div class="post-body">
                            <div class="post-header">
                                <span class="post-name">${p.user}</span>
                                <span class="post-meta">• ${p.minutesAgo} min • ${p.category}</span>
                            </div>
                            <div class="post-content">${p.content}</div>
                            ${renderAttachments(p.attachments)}
                            <div class="post-actions">
                                <span class="post-action" data-action="comment" data-id="${p.id}"><i class="fas fa-comment"></i> Comentar</span>
                                <span class="post-action shares" data-share="${p.id}"><i class="fas fa-share"></i> Compartir</span>
                                <span class="react-area">
                                    <button class="react-btn" data-react-toggle="${p.id}" title="Reaccionar">👍</button>
                                    <div class="reaction-picker" id="picker-${p.id}">
                                        <div class="reaction-item" data-react="like" data-id="${p.id}">👍</div>
                                        <div class="reaction-item" data-react="heart" data-id="${p.id}">❤️</div>
                                        <div class="reaction-item" data-react="wow" data-id="${p.id}">😮</div>
                                        <div class="reaction-item" data-react="laugh" data-id="${p.id}">😂</div>
                                        <div class="reaction-item" data-react="sad" data-id="${p.id}">😢</div>
                                    </div>
                                    <span class="reaction-summary">${reactionSummary(p.reactions)}</span>
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
                // abrir modal de post
                list.querySelectorAll('[data-open-post]').forEach(card=>{
                    card.addEventListener('click', (e)=>{
                        // evitar disparar desde botones internos
                        const target = e.target;
                        if(target.closest('.react-area') || target.closest('.shares')) return;
                        const id = Number(card.getAttribute('data-open-post'));
                        openPostModal(id);
                    });
                });
                // abrir/cerrar picker de reacciones
                list.querySelectorAll('[data-react-toggle]').forEach(btn=>{
                    btn.addEventListener('click', ()=>{
                        const id = btn.getAttribute('data-react-toggle');
                        const picker = document.getElementById('picker-'+id);
                        const post = posts.find(p=>p.id===Number(id));
                        if(post.reacted){
                            // ya reaccionó: no permitir más
                            btn.disabled = true;
                            return;
                        }
                        document.querySelectorAll('.reaction-picker').forEach(p=>{ if(p!==picker) p.classList.remove('show'); });
                        picker.classList.toggle('show');
                    });
                });
                // aplicar reacción
                list.querySelectorAll('.reaction-item').forEach(el=>{
                    el.addEventListener('click', ()=>{
                        const id = Number(el.getAttribute('data-id'));
                        const type = el.getAttribute('data-react');
                        const post = posts.find(p=>p.id===id);
                        if(post.reacted){ return; }
                        post.reactions[type] = (post.reactions[type]||0) + 1;
                        post.reacted = type;
                        renderPosts(category);
                    });
                });
                // compartir
                list.querySelectorAll('[data-share]').forEach(el=>{
                    el.addEventListener('click', async ()=>{
                        const id = Number(el.getAttribute('data-share'));
                        const post = posts.find(p=>p.id===id);
                        try{
                            await navigator.clipboard.writeText(post.content);
                            alert('Enlace/copete copiado al portapapeles.');
                        }catch(e){ alert('No se pudo copiar.'); }
                    });
                });
            }
            document.querySelectorAll('.feed-chip').forEach(chip=>{
                chip.addEventListener('click', ()=>{
                    document.querySelectorAll('.feed-chip').forEach(c=>c.classList.remove('active'));
                    chip.classList.add('active');
                    renderPosts(chip.dataset.category);
                });
            });
            // Adjuntos
            function bytesToMB(bytes){ return bytes / (1024*1024); }
            function addPreviewImage(src){
                const preview = document.getElementById('attachmentsPreview');
                const wrap = document.createElement('div');
                wrap.className = 'preview-item';
                wrap.innerHTML = `<img src="${src}" class="preview-thumb"><button class="preview-remove">✕</button>`;
                wrap.querySelector('.preview-remove').onclick = ()=>{ preview.removeChild(wrap); pendingAttachments = pendingAttachments.filter(a=>a.src!==src); };
                preview.appendChild(wrap);
            }
            function addPreviewPdf(name){
                const preview = document.getElementById('attachmentsPreview');
                const wrap = document.createElement('div');
                wrap.className = 'pdf-chip';
                wrap.innerHTML = `<i class="fas fa-file-pdf"></i> ${name} <button class="preview-remove">✕</button>`;
                wrap.querySelector('.preview-remove').onclick = ()=>{ preview.removeChild(wrap); pendingAttachments = pendingAttachments.filter(a=>a.name!==name); };
                preview.appendChild(wrap);
            }

            function addPreviewDocument(name){
                const preview = document.getElementById('attachmentsPreview');
                const wrap = document.createElement('div');
                wrap.className = 'document-chip';
                const icon = getDocumentIcon(name);
                wrap.innerHTML = `<i class="${icon}"></i> ${name} <button class="preview-remove">✕</button>`;
                wrap.querySelector('.preview-remove').onclick = ()=>{ preview.removeChild(wrap); pendingAttachments = pendingAttachments.filter(a=>a.name!==name); };
                preview.appendChild(wrap);
            }
            
            function getDocumentIcon(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                switch(ext) {
                    case 'pdf': return 'fas fa-file-pdf';
                    case 'doc':
                    case 'docx': return 'fas fa-file-word';
                    case 'xls':
                    case 'xlsx': return 'fas fa-file-excel';
                    case 'ppt':
                    case 'pptx': return 'fas fa-file-powerpoint';
                    case 'txt': return 'fas fa-file-alt';
                    default: return 'fas fa-file';
                }
            }
            
            function addPreviewLink(url){
                const preview = document.getElementById('attachmentsPreview');
                const wrap = document.createElement('div');
                wrap.className = 'link-chip';
                const domain = new URL(url).hostname.replace('www.', '');
                wrap.innerHTML = `<i class="fas fa-link"></i> ${domain} <button class="preview-remove">✕</button>`;
                wrap.querySelector('.preview-remove').onclick = ()=>{ preview.removeChild(wrap); pendingAttachments = pendingAttachments.filter(a=>a.url!==url); };
                preview.appendChild(wrap);
            }
            
            function addPreviewYoutube(embed){
                const preview = document.getElementById('attachmentsPreview');
                const wrap = document.createElement('div');
                wrap.className = 'youtube-chip';
                wrap.innerHTML = `<i class="fab fa-youtube"></i> Video de YouTube <button class="preview-remove">✕</button>`;
                wrap.querySelector('.preview-remove').onclick = ()=>{ preview.removeChild(wrap); pendingAttachments = pendingAttachments.filter(a=>a.embed!==embed); };
                preview.appendChild(wrap);
            }
            
            function addPreviewLocation(location){
                const preview = document.getElementById('attachmentsPreview');
                const wrap = document.createElement('div');
                wrap.className = 'location-chip';
                wrap.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${location} <button class="preview-remove">✕</button>`;
                wrap.querySelector('.preview-remove').onclick = ()=>{ preview.removeChild(wrap); pendingAttachments = pendingAttachments.filter(a=>a.text!==location); };
                preview.appendChild(wrap);
            }
            
            function addPreviewPoll(question, options){
                const preview = document.getElementById('attachmentsPreview');
                const wrap = document.createElement('div');
                wrap.className = 'poll-chip';
                wrap.innerHTML = `
                    <div class="poll-preview">
                        <i class="fas fa-poll"></i>
                        <div class="poll-content">
                            <div class="poll-question">${question}</div>
                            <div class="poll-options">${options.map(opt => `<div class="poll-option">${opt}</div>`).join('')}</div>
                        </div>
                        <button class="preview-remove">✕</button>
                    </div>
                `;
                wrap.querySelector('.preview-remove').onclick = ()=>{ 
                    preview.removeChild(wrap); 
                    pendingAttachments = pendingAttachments.filter(a=>a.question!==question); 
                };
                preview.appendChild(wrap);
            }

            // Manejo del modal de adjuntos
            const attachMenuBtn = document.getElementById('attachMenuBtn');
            const attachModal = document.getElementById('attachModal');
            const closeAttachModal = document.getElementById('closeAttachModal');
            
            // Abrir modal
            attachMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                attachModal.classList.add('show');
            });
            
            // Cerrar modal
            closeAttachModal.addEventListener('click', () => {
                attachModal.classList.remove('show');
            });
            
            // Cerrar modal al hacer clic fuera
            attachModal.addEventListener('click', (e) => {
                if (e.target === attachModal) {
                    attachModal.classList.remove('show');
                }
            });
            
            // Manejo de opciones del modal
            document.querySelectorAll('.attach-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const type = option.getAttribute('data-type');
                    handleAttachmentType(type);
                    attachModal.classList.remove('show');
                });
            });
            
            function handleAttachmentType(type) {
                switch(type) {
                    case 'image':
                        document.getElementById('attachImage').click();
                        break;
                    case 'document':
                        document.getElementById('attachDocument').click();
                        break;
                    case 'link':
                        document.getElementById('linkModal').classList.add('show');
                        break;
                    case 'youtube':
                        document.getElementById('youtubeModal').classList.add('show');
                        break;
                    case 'location':
                        document.getElementById('locationModal').classList.add('show');
                        break;
                    case 'poll':
                        document.getElementById('pollModal').classList.add('show');
                        break;
                }
            }
            document.getElementById('attachImage').addEventListener('change', (e)=>{
                const file = e.target.files?.[0];
                if(!file) return;
                if(bytesToMB(file.size) > 10){ alert('Imagen supera 10MB'); return; }
                const reader = new FileReader();
                reader.onload = ()=>{ pendingAttachments.push({ type:'image', src: reader.result }); addPreviewImage(reader.result); };
                reader.readAsDataURL(file);
                e.target.value='';
            });
            document.getElementById('attachPdf').addEventListener('change', (e)=>{
                const file = e.target.files?.[0];
                if(!file) return;
                if(bytesToMB(file.size) > 10){ alert('PDF supera 10MB'); return; }
                const reader = new FileReader();
                reader.onload = ()=>{ pendingAttachments.push({ type:'pdf', name: file.name, dataUrl: reader.result }); addPreviewPdf(file.name); };
                reader.readAsDataURL(file);
                e.target.value='';
            });
            
            document.getElementById('attachDocument').addEventListener('change', (e)=>{
                const file = e.target.files?.[0];
                if(!file) return;
                if(bytesToMB(file.size) > 10){ alert('Documento supera 10MB'); return; }
                const reader = new FileReader();
                reader.onload = ()=>{ pendingAttachments.push({ type:'document', name: file.name, dataUrl: reader.result }); addPreviewDocument(file.name); };
                reader.readAsDataURL(file);
                e.target.value='';
            });

            function youtubeEmbed(url){
                const m = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([\w-]{11})/);
                return m ? `https://www.youtube.com/embed/${m[1]}` : null;
            }

            function renderAttachments(att){
                if(!att || att.length===0) return '';
                return `<div class='attachments-preview'>` + att.map(a=>{
                    if(a.type==='image') return `<img src='${a.src}' class='preview-thumb'>`;
                    if(a.type==='youtube') return `<iframe width='240' height='135' src='${a.embed}' frameborder='0' allowfullscreen></iframe>`;
                    if(a.type==='pdf') return `<a href='${a.dataUrl}' target='_blank' class='pdf-chip'><i class='fas fa-file-pdf'></i> ${a.name}</a>`;
                    if(a.type==='document') return `<a href='${a.dataUrl}' target='_blank' class='document-chip'><i class='${getDocumentIcon(a.name)}'></i> ${a.name}</a>`;
                    if(a.type==='link') return `<a href='${a.url}' target='_blank' class='link-chip'><i class='fas fa-link'></i> ${new URL(a.url).hostname.replace('www.', '')}</a>`;
                    if(a.type==='location') return `<div class='location-chip'><i class='fas fa-map-marker-alt'></i> ${a.text}</div>`;
                    if(a.type==='poll') return `<div class='poll-chip'><i class='fas fa-poll'></i> ${a.question} (${a.options.length} opciones)</div>`;
                    return '';
                }).join('') + `</div>`;
            }

            // resumen de reacciones
            function reactionSummary(r){
                if(!r) return '';
                const total = Object.values(r).reduce((a,b)=>a+(b||0),0);
                if(total===0) return '';
                const icons = [];
                if(r.like) icons.push('👍');
                if(r.heart) icons.push('❤️');
                if(r.wow) icons.push('😮');
                if(r.laugh) icons.push('😂');
                if(r.sad) icons.push('😢');
                return icons.join(' ') + ' ' + total;
            }

            // Modal de post
            function openPostModal(id){
                const modal = document.getElementById('postModal');
                const body = document.getElementById('modalPostBody');
                const userEl = document.getElementById('modalPostUser');
                const post = posts.find(p=>p.id===id);
                if(!post) return;
                
                // Mostrar el título de la publicación (contenido truncado) en lugar del nombre del usuario
                const title = post.content.length > 50 ? post.content.substring(0, 50) + '...' : post.content;
                userEl.textContent = title;
                body.innerHTML = `
                    <div class="post-card">
                        <div class="post-avatar"><i class="${post.avatar}"></i></div>
                        <div class="post-body">
                            <div class="post-header">
                                <span class="post-name">${post.user}</span>
                                <span class="post-meta">${post.minutesAgo} min <span>•</span> ${post.category}</span>
                            </div>
                            <div class="post-content">${post.content}</div>
                            ${renderAttachments(post.attachments)}
                            <div class="post-modal-actions">
                                <span class="shares" data-share="${post.id}"><i class="fas fa-share"></i> Compartir</span>
                                <span>${reactionSummary(post.reactions)}</span>
                            </div>
                            <div id="modalComments" class="comment-list">
                                ${(post.comments||[]).map(c=>commentTemplate(c)).join('')}
                            </div>
                        </div>
                    </div>
                `;
                // comentar desde modal
                document.getElementById('modalSendComment').onclick = ()=>{
                    const input = document.getElementById('modalCommentInput');
                    const txt = (input.value||'').trim();
                    if(!txt) return;
                    post.comments.push({ user:'Tú', time:'ahora', text: txt });
                    input.value='';
                    document.getElementById('modalComments').innerHTML = (post.comments||[]).map(c=>commentTemplate(c)).join('');
                };
                document.getElementById('closePostModal').onclick = ()=> modal.classList.remove('show');
                modal.classList.add('show');
            }
            function commentTemplate(c){
                if(typeof c === 'string') return `<div class='comment-item'><div class='comment-avatar'><i class="fas fa-user"></i></div><div class='comment-bubble'><div class='comment-head'><span class='comment-name'>Usuario</span><span class='comment-time'>ahora</span></div><div>${c}</div></div></div>`;
                return `<div class='comment-item'><div class='comment-avatar'><i class="fas fa-user"></i></div><div class='comment-bubble'><div class='comment-head'><span class='comment-name'>${c.user||'Usuario'}</span><span class='comment-time'>${c.time||''}</span></div><div>${c.text||c}</div></div></div>`;
            }

            if(composerInput && publishPostBtn){
                composerInput.addEventListener('input', ()=>{
                    const ok = composerInput.value.trim().length>0;
                    publishPostBtn.disabled = !ok;
                    publishPostBtn.classList.toggle('enabled', ok);
                });
                publishPostBtn.addEventListener('click', ()=>{
                    const txt = composerInput.value.trim();
                    if(!txt) return;
                    posts.unshift({ id: Date.now(), user:'Tú', avatar:'fas fa-user', category:(document.querySelector('.feed-chip.active')?.dataset.category||'ia'), minutesAgo:0, content:txt, comments:[], reactions:{like:0, heart:0, wow:0, laugh:0, sad:0}, attachments: pendingAttachments.slice(0), reacted: null });
                    composerInput.value='';
                    publishPostBtn.disabled = true;
                    publishPostBtn.classList.remove('enabled');
                    pendingAttachments = []; document.getElementById('attachmentsPreview').innerHTML='';
                    renderPosts(document.querySelector('.feed-chip.active')?.dataset.category||'all');
                });
            }
            renderPosts('all');

            // Members mock
            const mockMembers = Array.from({length: 20}).map((_,i)=>({
                id: i+1,
                name: ['Titus Blair','Michael W.','Laura F.','Ana Martínez','Carlos López','María González'][i%6] + ' ' + (i+1),
                online: i%3!==0,
                admin: i%10===0,
                location: ['CDMX','Madrid','Buenos Aires','Bogotá'][i%4],
                joined: '2025-01-1'+(i%9),
            }));
            function renderMembers(filter='all', q=''){
                const list = document.getElementById('membersList');
                let data = [...mockMembers];
                if(filter==='online') data = data.filter(m=>m.online);
                if(filter==='admins') data = data.filter(m=>m.admin);
                if(q) data = data.filter(m => (m.name+ ' ' + m.location).toLowerCase().includes(q.toLowerCase()));
                list.innerHTML = data.map(m=>`
                    <div class="member-card">
                        <div class="member-avatar">
                            <i class="fas fa-user"></i>
                            ${m.online ? '<span class="member-status"></span>' : ''}
                        </div>
                        <div>
                            <div class="member-name">${m.name} ${m.admin ? '<span class="post-tag">admin</span>':''}</div>
                            <div class="member-meta"><span>${m.online? 'Online now':'Offline'}</span> • <span>${m.location}</span> • <span>Joined ${m.joined}</span></div>
                        </div>
                    </div>
                `).join('');
            }
            document.querySelectorAll('.members-chip').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    document.querySelectorAll('.members-chip').forEach(b=>b.classList.remove('active'));
                    btn.classList.add('active');
                    renderMembers(btn.dataset.filter, document.getElementById('viewSearch').value);
                });
            });
            const search = document.getElementById('viewSearch');
            search.addEventListener('input', ()=>{
                const active = document.querySelector('.members-chip.active');
                renderMembers(active?active.dataset.filter:'all', search.value);
            });
            renderMembers();

            // Chat
            const chatPanel = document.getElementById('chatPanel');
            const chatBody = document.getElementById('chatBody');
            const chatInput = document.getElementById('chatInput');
            document.getElementById('openChat').addEventListener('click', ()=> chatPanel.classList.add('show'));
            document.getElementById('closeChat').addEventListener('click', ()=> chatPanel.classList.remove('show'));
            document.getElementById('chatSend').addEventListener('click', sendChat);
            chatInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ sendChat(); }});
            function sendChat(){
                const text = (chatInput.value||'').trim();
                if(!text) return;
                appendChat(text, true);
                chatInput.value='';
                setTimeout(()=> appendChat('¡Gracias por tu mensaje! 👋', false), 800);
            }
            function appendChat(text, own){
                const el = document.createElement('div');
                el.className = 'chat-msg' + (own?' own':'');
                el.textContent = text;
                chatBody.appendChild(el);
                chatBody.scrollTop = chatBody.scrollHeight;
            }

            // Manejo de modales de entrada personalizados
            function setupInputModals() {
                // Modal de enlace
                const linkModal = document.getElementById('linkModal');
                const linkInput = document.getElementById('linkInput');
                const confirmLink = document.getElementById('confirmLink');
                const cancelLink = document.getElementById('cancelLink');
                const closeLinkModal = document.getElementById('closeLinkModal');

                function closeLinkModalFunc() {
                    linkModal.classList.remove('show');
                    linkInput.value = '';
                }

                confirmLink.addEventListener('click', () => {
                    const url = linkInput.value.trim();
                    if (url) {
                        pendingAttachments.push({ type: 'link', url });
                        addPreviewLink(url);
                        closeLinkModalFunc();
                    }
                });

                cancelLink.addEventListener('click', closeLinkModalFunc);
                closeLinkModal.addEventListener('click', closeLinkModalFunc);
                linkModal.addEventListener('click', (e) => {
                    if (e.target === linkModal) closeLinkModalFunc();
                });

                // Modal de YouTube
                const youtubeModal = document.getElementById('youtubeModal');
                const youtubeInput = document.getElementById('youtubeInput');
                const confirmYoutube = document.getElementById('confirmYoutube');
                const cancelYoutube = document.getElementById('cancelYoutube');
                const closeYoutubeModal = document.getElementById('closeYoutubeModal');

                function closeYoutubeModalFunc() {
                    youtubeModal.classList.remove('show');
                    youtubeInput.value = '';
                }

                confirmYoutube.addEventListener('click', () => {
                    const ytUrl = youtubeInput.value.trim();
                    if (ytUrl) {
                        const embed = youtubeEmbed(ytUrl);
                        if (embed) {
                            pendingAttachments.push({ type: 'youtube', embed });
                            addPreviewYoutube(embed);
                            closeYoutubeModalFunc();
                        } else {
                            alert('Enlace de YouTube inválido');
                        }
                    }
                });

                cancelYoutube.addEventListener('click', closeYoutubeModalFunc);
                closeYoutubeModal.addEventListener('click', closeYoutubeModalFunc);
                youtubeModal.addEventListener('click', (e) => {
                    if (e.target === youtubeModal) closeYoutubeModalFunc();
                });

                // Modal de ubicación
                const locationModal = document.getElementById('locationModal');
                const locationInput = document.getElementById('locationInput');
                const confirmLocation = document.getElementById('confirmLocation');
                const cancelLocation = document.getElementById('cancelLocation');
                const closeLocationModal = document.getElementById('closeLocationModal');

                function closeLocationModalFunc() {
                    locationModal.classList.remove('show');
                    locationInput.value = '';
                }

                confirmLocation.addEventListener('click', () => {
                    const location = locationInput.value.trim();
                    if (location) {
                        pendingAttachments.push({ type: 'location', text: location });
                        addPreviewLocation(location);
                        closeLocationModalFunc();
                    }
                });

                cancelLocation.addEventListener('click', closeLocationModalFunc);
                closeLocationModal.addEventListener('click', closeLocationModalFunc);
                locationModal.addEventListener('click', (e) => {
                    if (e.target === locationModal) closeLocationModalFunc();
                });

                // Modal de encuesta
                const pollModal = document.getElementById('pollModal');
                const pollQuestion = document.getElementById('pollQuestion');
                const pollOptions = document.getElementById('pollOptions');
                const confirmPoll = document.getElementById('confirmPoll');
                const cancelPoll = document.getElementById('cancelPoll');
                const closePollModal = document.getElementById('closePollModal');

                function closePollModalFunc() {
                    pollModal.classList.remove('show');
                    pollQuestion.value = '';
                    pollOptions.value = '';
                }

                confirmPoll.addEventListener('click', () => {
                    const question = pollQuestion.value.trim();
                    const options = pollOptions.value.trim();
                    if (question && options) {
                        const pollOptionsArray = options.split(',').map(opt => opt.trim()).filter(opt => opt);
                        if (pollOptionsArray.length >= 2) {
                            pendingAttachments.push({ 
                                type: 'poll', 
                                question, 
                                options: pollOptionsArray 
                            });
                            addPreviewPoll(question, pollOptionsArray);
                            closePollModalFunc();
                        } else {
                            alert('Necesitas al menos 2 opciones para la encuesta');
                        }
                    }
                });

                cancelPoll.addEventListener('click', closePollModalFunc);
                closePollModal.addEventListener('click', closePollModalFunc);
                pollModal.addEventListener('click', (e) => {
                    if (e.target === pollModal) closePollModalFunc();
                });
            }

            // Inicializar modales de entrada
            setupInputModals();
            
            // Escuchar cambios en el localStorage para actualizar la foto de perfil
            window.addEventListener('storage', function(e) {
                if (e.key === 'avatarData' || e.key === 'userProfile') {
                    loadUserProfilePicture();
                }
            });
            
            // También escuchar cambios locales (misma pestaña)
            const originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                originalSetItem.apply(this, arguments);
                if (key === 'avatarData' || key === 'userProfile') {
                    loadUserProfilePicture();
                }
            };
        })();
    </script>
    <script src="../scripts/theme-toggle.js"></script>
</body>
</html>


