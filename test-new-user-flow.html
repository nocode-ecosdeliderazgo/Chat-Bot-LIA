<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Flujo Usuario Nuevo</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { border: 1px solid #ccc; margin: 20px 0; padding: 20px; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
        .result { margin-top: 10px; padding: 10px; border-radius: 4px; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Test - Flujo Usuario Nuevo</h1>
    <p>Esta p√°gina permite probar el flujo completo de registro de un usuario nuevo y verificar que se asigne cargo_rol y se redirija al perfil-cuestionario seguido del cuestionario.</p>
    
    <div class="info section">
        <h3>üìã Flujo Esperado para Usuarios Nuevos:</h3>
        <ol>
            <li><strong>Registro:</strong> Se asigna autom√°ticamente <code>cargo_rol = 'usuario'</code></li>
            <li><strong>Primer Login:</strong> Se detecta <code>isNewUser = true</code> (basado en <code>last_login_at = null</code>)</li>
            <li><strong>Redirecci√≥n 1:</strong> Va a <code>../perfil-cuestionario.html</code> (formulario de perfil profesional)</li>
            <li><strong>Completar perfil:</strong> Usuario llena datos profesionales y selecciona perfil</li>
            <li><strong>Redirecci√≥n 2:</strong> Va a <code>q/form.html</code> (cuestionario adaptativo)</li>
            <li><strong>Completar cuestionario:</strong> Se actualiza <code>type_rol</code> en BD y se guardan respuestas</li>
            <li><strong>Auto-login:</strong> Inicia sesi√≥n autom√°ticamente y redirige seg√∫n rol</li>
            <li><strong>Logins posteriores:</strong> Van directamente a p√°gina seg√∫n rol</li>
        </ol>
    </div>

    <!-- Registro -->
    <div class="section">
        <h2>1. Registro de Usuario Nuevo</h2>
        <input type="text" id="regFullName" placeholder="Nombre completo" value="Usuario Prueba">
        <input type="text" id="regUsername" placeholder="Username" value="userprueba">
        <input type="email" id="regEmail" placeholder="Email" value="userprueba@test.com">
        <input type="password" id="regPassword" placeholder="Password" value="password123">
        <br>
        <button onclick="testRegister()">Registrar Usuario</button>
        <div id="registerResult" class="result"></div>
    </div>

    <!-- Login -->
    <div class="section">
        <h2>2. Primer Login (Deber√≠a detectar usuario nuevo)</h2>
        <input type="text" id="loginUsername" placeholder="Email o Username" value="userprueba@test.com">
        <input type="password" id="loginPassword" placeholder="Password" value="password123">
        <br>
        <button onclick="testLogin()">Hacer Login</button>
        <div id="loginResult" class="result"></div>
    </div>

    <!-- Verificar BD -->
    <div class="section">
        <h2>3. Verificar Estado del Usuario en BD</h2>
        <input type="text" id="checkUsername" placeholder="Username para verificar" value="userprueba">
        <br>
        <button onclick="checkUserInDB()">Verificar en BD</button>
        <div id="checkResult" class="result"></div>
    </div>

    <!-- Probar actualizaci√≥n de perfil -->
    <div class="section">
        <h2>4. Probar Actualizaci√≥n de type_rol</h2>
        <input type="text" id="updateUsername" placeholder="Username" value="">
        <select id="updateTypeRol">
            <option value="">Seleccionar type_rol</option>
            <option value="CEO (personal)">CEO (personal)</option>
            <option value="CTO/CIO">CTO/CIO</option>
            <option value="Direcci√≥n de Ventas">Direcci√≥n de Ventas</option>
            <option value="Miembros de Ventas">Miembros de Ventas</option>
            <option value="Direcci√≥n de Marketing">Direcci√≥n de Marketing</option>
            <option value="Miembros de Marketing">Miembros de Marketing</option>
        </select>
        <br>
        <button onclick="testUpdateProfile()">Actualizar Perfil</button>
        <div id="updateResult" class="result"></div>
    </div>

    <!-- Limpiar -->
    <div class="section">
        <h2>5. Limpiar Datos de Prueba</h2>
        <button onclick="clearTestData()">Limpiar localStorage</button>
        <div id="clearResult" class="result"></div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `result ${type}`;
        }

        async function testRegister() {
            const fullName = document.getElementById('regFullName').value;
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            if (!fullName || !username || !email || !password) {
                showResult('registerResult', 'Por favor completa todos los campos', 'error');
                return;
            }

            try {
                showResult('registerResult', 'Registrando usuario...', 'info');
                
                const response = await fetch(`${API_BASE}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        full_name: fullName,
                        username: username,
                        email: email,
                        password: password
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('registerResult', `
                        <strong>‚úÖ REGISTRO EXITOSO</strong><br>
                        <strong>Estado HTTP:</strong> ${response.status}<br>
                        <strong>Usuario creado:</strong><br>
                        <pre>${JSON.stringify(result.user, null, 2)}</pre>
                        <strong>cargo_rol asignado:</strong> ${result.user.cargo_rol || 'NO ASIGNADO'}<br>
                        <strong>isNewUser:</strong> ${result.user.isNewUser}
                    `, 'success');
                    
                    // Auto-fill login form
                    document.getElementById('loginUsername').value = email;
                    document.getElementById('loginPassword').value = password;
                } else {
                    showResult('registerResult', `
                        <strong>‚ùå ERROR EN REGISTRO</strong><br>
                        <strong>Estado HTTP:</strong> ${response.status}<br>
                        <strong>Error:</strong> ${result.error}<br>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `, 'error');
                }
            } catch (error) {
                showResult('registerResult', `
                    <strong>‚ùå ERROR DE CONEXI√ìN</strong><br>
                    ${error.message}
                `, 'error');
            }
        }

        async function testLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                showResult('loginResult', 'Por favor completa todos los campos', 'error');
                return;
            }

            try {
                showResult('loginResult', 'Iniciando sesi√≥n...', 'info');
                
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('loginResult', `
                        <strong>‚úÖ LOGIN EXITOSO</strong><br>
                        <strong>Estado HTTP:</strong> ${response.status}<br>
                        <strong>Datos del usuario:</strong><br>
                        <pre>${JSON.stringify(result.user, null, 2)}</pre>
                        <strong>cargo_rol:</strong> ${result.user.cargo_rol || 'NO ASIGNADO'}<br>
                        <strong>isNewUser:</strong> ${result.user.isNewUser}<br>
                        <strong>Redirecci√≥n esperada:</strong> ${result.user.isNewUser ? '../perfil-cuestionario.html ‚Üí q/form.html (PERFIL + CUESTIONARIO)' : 'P√°gina de rol correspondiente'}
                    `, 'success');
                    
                    // Auto-fill check form and update form
                    document.getElementById('checkUsername').value = result.user.username;
                    document.getElementById('updateUsername').value = result.user.username;
                } else {
                    showResult('loginResult', `
                        <strong>‚ùå ERROR EN LOGIN</strong><br>
                        <strong>Estado HTTP:</strong> ${response.status}<br>
                        <strong>Error:</strong> ${result.error}<br>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `, 'error');
                }
            } catch (error) {
                showResult('loginResult', `
                    <strong>‚ùå ERROR DE CONEXI√ìN</strong><br>
                    ${error.message}
                `, 'error');
            }
        }

        async function checkUserInDB() {
            const username = document.getElementById('checkUsername').value;
            
            if (!username) {
                showResult('checkResult', 'Por favor ingresa un username para verificar', 'error');
                return;
            }

            try {
                showResult('checkResult', 'Verificando usuario en BD...', 'info');
                
                // Intentar hacer login para ver los datos actuales
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        password: document.getElementById('loginPassword').value || 'password123'
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('checkResult', `
                        <strong>‚úÖ USUARIO ENCONTRADO EN BD</strong><br>
                        <strong>Datos actuales:</strong><br>
                        <pre>${JSON.stringify(result.user, null, 2)}</pre>
                        <strong>cargo_rol en BD:</strong> ${result.user.cargo_rol || 'NULL/NO ASIGNADO'}<br>
                        <strong>last_login_at actualizado:</strong> ${result.user.isNewUser ? 'NO (primer login)' : 'S√ç (login previo)'}<br>
                        <strong>isNewUser:</strong> ${result.user.isNewUser}
                    `, 'success');
                } else {
                    showResult('checkResult', `
                        <strong>‚ùå NO SE PUDO VERIFICAR</strong><br>
                        ${result.error}
                    `, 'error');
                }
            } catch (error) {
                showResult('checkResult', `
                    <strong>‚ùå ERROR DE CONEXI√ìN</strong><br>
                    ${error.message}
                `, 'error');
            }
        }

        async function testUpdateProfile() {
            const username = document.getElementById('updateUsername').value;
            const typeRol = document.getElementById('updateTypeRol').value;

            if (!username || !typeRol) {
                showResult('updateResult', 'Por favor completa username y type_rol', 'error');
                return;
            }

            try {
                showResult('updateResult', 'Actualizando perfil...', 'info');
                
                const response = await fetch(`${API_BASE}/api/update-profile`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'dev-api-key'
                    },
                    body: JSON.stringify({
                        username: username,
                        type_rol: typeRol
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    showResult('updateResult', `
                        <strong>‚úÖ PERFIL ACTUALIZADO</strong><br>
                        <strong>Estado HTTP:</strong> ${response.status}<br>
                        <strong>Usuario actualizado:</strong><br>
                        <pre>${JSON.stringify(result.user, null, 2)}</pre>
                        <strong>type_rol nuevo:</strong> ${result.user.type_rol}<br>
                        <strong>cargo_rol:</strong> ${result.user.cargo_rol}
                    `, 'success');
                } else {
                    showResult('updateResult', `
                        <strong>‚ùå ERROR ACTUALIZANDO PERFIL</strong><br>
                        <strong>Estado HTTP:</strong> ${response.status}<br>
                        <strong>Error:</strong> ${result.error}<br>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `, 'error');
                }
            } catch (error) {
                showResult('updateResult', `
                    <strong>‚ùå ERROR DE CONEXI√ìN</strong><br>
                    ${error.message}
                `, 'error');
            }
        }

        function clearTestData() {
            localStorage.clear();
            showResult('clearResult', '‚úÖ localStorage limpiado', 'success');
        }

        // Auto-generar datos √∫nicos cada vez
        window.addEventListener('load', () => {
            const timestamp = Date.now();
            document.getElementById('regUsername').value = `testuser${timestamp}`;
            document.getElementById('regEmail').value = `testuser${timestamp}@test.com`;
            document.getElementById('loginUsername').value = `testuser${timestamp}@test.com`;
            document.getElementById('checkUsername').value = `testuser${timestamp}`;
            document.getElementById('updateUsername').value = `testuser${timestamp}`;
        });
    </script>
</body>
</html>