<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Main Server - Grafana Images</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-container {
            margin: 20px 0;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #FF9800; }
        .info { color: #2196F3; }
        img {
            max-width: 100%;
            border: 2px solid #444;
            border-radius: 8px;
            margin: 10px 0;
            background: #333;
        }
        .cache-buster {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        button {
            background: #44e5ff;
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>üîç Test Main Server - Grafana Images</h1>
    
    <div class="test-container">
        <h2>Server Status</h2>
        <p>Testing main server on port 3000...</p>
        <div id="server-status"></div>
        <button onclick="testServerHealth()">Test Server Health</button>
    </div>

    <div class="test-container">
        <h2>Grafana Images Test (with Cache Buster)</h2>
        <button onclick="reloadImages()">üîÑ Reload Images (Clear Cache)</button>
        
        <h3>Panel 1 - √çndice de Competencias:</h3>
        <img id="panel-1" src="/grafana/panel/1.png" alt="Panel 1" onload="imageLoaded(this)" onerror="imageError(this)">
        <div class="cache-buster">URL: <span id="url-1"></span></div>
        
        <h3>Panel 2 - Radar de Habilidades:</h3>
        <img id="panel-2" src="/grafana/panel/2.png" alt="Panel 2" onload="imageLoaded(this)" onerror="imageError(this)">
        <div class="cache-buster">URL: <span id="url-2"></span></div>
        
        <h3>Panel 3 - An√°lisis por Subdominios:</h3>
        <img id="panel-3" src="/grafana/panel/3.png" alt="Panel 3" onload="imageLoaded(this)" onerror="imageError(this)">
        <div class="cache-buster">URL: <span id="url-3"></span></div>
    </div>

    <div class="test-container">
        <h2>Image Load Results</h2>
        <div id="results"></div>
    </div>

    <script>
        let results = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            results.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateResults();
        }
        
        function updateResults() {
            document.getElementById('results').innerHTML = 
                '<pre>' + results.slice(-10).join('\n') + '</pre>';
        }
        
        async function testServerHealth() {
            const statusDiv = document.getElementById('server-status');
            statusDiv.innerHTML = '<p class="info">Testing server health...</p>';
            
            try {
                const response = await fetch('/grafana/health');
                const data = await response.json();
                
                let html = '<h3 class="success">‚úÖ Server Health Results:</h3>';
                html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                
                if (data.grafana_configured) {
                    html += '<p class="success">‚úÖ Grafana is configured</p>';
                } else {
                    html += '<p class="error">‚ùå Grafana is NOT configured</p>';
                }
                
                statusDiv.innerHTML = html;
                log('Server health test completed');
                
            } catch (error) {
                statusDiv.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
                log(`Server health test failed: ${error.message}`, 'error');
            }
        }
        
        function reloadImages() {
            log('Reloading images with cache buster...');
            const timestamp = new Date().getTime();
            
            for (let i = 1; i <= 3; i++) {
                const img = document.getElementById(`panel-${i}`);
                const urlSpan = document.getElementById(`url-${i}`);
                const newSrc = `/grafana/panel/${i}.png?t=${timestamp}`;
                
                img.src = newSrc;
                urlSpan.textContent = newSrc;
                log(`Panel ${i} URL updated: ${newSrc}`);
            }
        }
        
        function imageLoaded(img) {
            const panelId = img.id.split('-')[1];
            log(`‚úÖ Panel ${panelId} loaded successfully`, 'success');
            
            // Check if image has real content (not a small placeholder)
            const imgSize = img.naturalWidth * img.naturalHeight;
            if (imgSize > 100000) { // Assume real images are > 100k pixels
                log(`‚úÖ Panel ${panelId} appears to have real data (${img.naturalWidth}x${img.naturalHeight})`, 'success');
            } else {
                log(`‚ö†Ô∏è Panel ${panelId} might be a placeholder (${img.naturalWidth}x${img.naturalHeight})`, 'warning');
            }
        }
        
        function imageError(img) {
            const panelId = img.id.split('-')[1];
            log(`‚ùå Panel ${panelId} failed to load`, 'error');
            img.style.border = '2px solid #f44336';
        }
        
        // Auto-run tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            log('Main server test page loaded');
            
            // Update URLs display
            for (let i = 1; i <= 3; i++) {
                const img = document.getElementById(`panel-${i}`);
                const urlSpan = document.getElementById(`url-${i}`);
                urlSpan.textContent = img.src;
            }
            
            // Auto-test server health
            setTimeout(testServerHealth, 1000);
        });
    </script>
</body>
</html>